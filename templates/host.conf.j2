server {
    listen 443 ssl http2 {% if "default" in item and item.default %} default_server {% endif %};
    server_name {{ item.primary }};

{% if "root" not in item %}
    root /var/www/{{ item.primary }};
{% else %}
    root /var/www-external/{{ item.primary }};
{% endif %}

{% if "locations" in item %}
{% for location in item.locations %}
    location {{ location.url }} {

{% if "root" in location %}
        root /var/www-external/{{ item.primary }}-{{ loop.index }};
{% endif %}

{% if "proxy" in location %}
        proxy_pass http://127.0.0.1:{{ location.proxy }}/;
        proxy_set_header Host            $host;
        proxy_set_header X-Forwarded-For $remote_addr;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Real-IP $remote_addr;
{% endif %}

{% if "proxy_ws" in location and location.proxy_ws %}
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
{% endif %}
    }
{% endfor %}
{% endif %}
}

{% if "aliases" in item %}
server {
    listen 443 ssl;
    server_name {% for alias in item.aliases %} {{ alias }} {% endfor %};
    return 301 https://{{ item.primary }}$request_uri;
}
{% endif %}

server {
    listen 80 {% if "default" in item and item.default %} default_server {% endif %};
    server_name {{ item.primary }} {% if "aliases" in item %} {% for alias in item.aliases %} {{ alias }} {% endfor %} {% endif %};
    return 301 https://{{ item.primary }}$request_uri;
}
