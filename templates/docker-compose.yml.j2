version: "3"

services:
  nginx:
    image: nginx:mainline-alpine
    restart: always
    network_mode: host
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./conf.d:/etc/nginx/conf.d:ro
      - ./auth:/etc/nginx/auth:ro
      - ./ssl:/etc/ssl/static:ro
      - ./www:/var/www:ro

{% if "ssl" in nginx %}
      - {{ nginx.ssl.cert }}:/etc/ssl/cert:ro
      - {{ nginx.ssl.key }}:/etc/ssl/key:ro
{% endif %}

{% for host in nginx.hosts %}

{% if "root" in host %}
      - {{ host.root }}:/var/www-external/{{ host.primary }}:ro
{% endif %}

{% if "locations" in host %}
{% for location in host.locations %}
{% if "root" in location %}
      - {{ location.root }}:/var/www-external/{{ host.primary }}-{{ loop.index }}:ro
{% endif %}
{% if "alias" in location %}
      - {{ location.alias }}:/var/www-external/{{ host.primary }}-{{ loop.index }}:ro
{% endif %}
{% endfor %}
{% endif %}

{% endfor %}
