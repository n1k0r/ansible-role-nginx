version: "3"

services:
  nginx:
    image: nginx:mainline-alpine
    restart: always
    network_mode: host
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./conf.d:/etc/nginx/conf.d:ro
      - ./auth:/etc/nginx/auth:ro
      - ./ssl:/etc/ssl:ro
      - ./www:/var/www:ro
      - /srv/certbot/config:/etc/letsencrypt:ro

{% if ssl is defined %}
      - {{ ssl.cert }}:/etc/ssl/cert:ro
      - {{ ssl.key }}:/etc/ssl/key:ro
{% endif %}

{% for host in hosts %}

{% if "root" in host %}
      - {{ host.root }}:/var/www-external/{{ host.primary }}:ro
{% endif %}

{% if "locations" in host %}
{% for location in host.locations %}
{% if "root" in location %}
      - {{ location.root }}:/var/www-external/{{ host.primary }}-{{ loop.index }}:ro
{% endif %}
{% if "alias" in location %}
      - {{ location.alias }}:/var/www-external/{{ host.primary }}-{{ loop.index }}:ro
{% endif %}
{% endfor %}
{% endif %}

{% endfor %}
